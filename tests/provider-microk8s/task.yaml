summary: Run concierge with just a MicroK8s provider (with metallb debug diagnostics)
systems:
  - ubuntu-24.04

execute: |
  pushd "${SPREAD_PATH}/${SPREAD_TASK}"

  echo "=== System info ==="
  uname -a
  free -h
  nproc
  df -h /
  echo "=== End system info ==="

  # Install microk8s and non-metallb addons via concierge, but with a modified
  # config that excludes metallb so we can run it separately with diagnostics.
  # We skip bootstrap (juju) to focus on the metallb issue and save CI time.
  mv concierge.yaml concierge.yaml.orig
  printf 'providers:\n  microk8s:\n    enable: true\n    bootstrap: false\n    channel: 1.31-strict/stable\n    addons:\n      - hostpath-storage\n      - dns\n' > concierge.yaml
  echo "=== concierge.yaml (metallb excluded for separate debug run) ==="
  cat concierge.yaml

  "$SPREAD_PATH"/concierge --trace prepare --extra-snaps="yq"

  list="$(snap list microk8s)"
  echo $list | MATCH microk8s
  echo $list | MATCH 1.31-strict/stable

  list="$(snap list)"
  echo $list | MATCH kubectl

  sudo microk8s status --format yaml | yq '.addons[] | select(.name=="hostpath-storage") | .status'
  sudo microk8s status --format yaml | yq '.addons[] | select(.name=="dns") | .status'

  # Now enable metallb with full diagnostics
  echo ""
  echo "=== Starting metallb debug diagnostics ==="
  sudo bash debug-metallb.sh 600

  # Verify metallb is enabled
  sudo microk8s status --format yaml | yq '.addons[] | select(.name=="metallb") | .status'

  kubectl config current-context | MATCH "microk8s"

restore: |
  if [[ -z "${CI:-}" ]]; then
    "$SPREAD_PATH"/concierge --trace restore
  fi
