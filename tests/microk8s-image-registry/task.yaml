summary: Test MicroK8s image registry configuration with a local authenticated mirror

systems:
  - ubuntu-24.04

environment:
  REGISTRY_USERNAME: testuser
  REGISTRY_PASSWORD: testpass

execute: |
  pushd "${SPREAD_PATH}/${SPREAD_TASK}"

  # Install htpasswd utility for generating auth credentials
  apt-get update -qq
  apt-get install -y -qq apache2-utils

  # Download and install Zot registry (minimal OCI-native registry with auth and mirroring support)
  ARCH=$(dpkg --print-architecture)
  ZOT_VERSION="v2.1.14"
  curl -fsSL "https://github.com/project-zot/zot/releases/download/${ZOT_VERSION}/zot-linux-${ARCH}" -o /usr/local/bin/zot
  chmod +x /usr/local/bin/zot

  # Set up Zot configuration
  mkdir -p /etc/zot /var/lib/zot
  htpasswd -Bbn "${REGISTRY_USERNAME}" "${REGISTRY_PASSWORD}" > /etc/zot/htpasswd

  cat > /etc/zot/config.json << 'ZOTCFG'
  {
    "distSpecVersion": "1.1.0",
    "storage": {
      "rootDirectory": "/var/lib/zot"
    },
    "http": {
      "address": "0.0.0.0",
      "port": "5000",
      "auth": {
        "htpasswd": {
          "path": "/etc/zot/htpasswd"
        }
      }
    },
    "extensions": {
      "sync": {
        "registries": [
          {
            "urls": ["https://registry-1.docker.io"],
            "onDemand": true,
            "content": [
              {
                "prefix": "**"
              }
            ]
          }
        ]
      }
    }
  }
  ZOTCFG

  # Start Zot in the background, redirecting output to a log file so spread
  # doesn't track its file descriptors and wait for them to close.
  zot serve /etc/zot/config.json > /var/log/zot.log 2>&1 &
  ZOT_PID=$!

  # Wait for Zot to be ready
  for i in $(seq 1 30); do
    if curl -sf -u "${REGISTRY_USERNAME}:${REGISTRY_PASSWORD}" http://localhost:5000/v2/ > /dev/null 2>&1; then
      break
    fi
    sleep 1
  done

  # Verify Zot requires authentication (unauthenticated request should fail)
  if curl -sf http://localhost:5000/v2/ > /dev/null 2>&1; then
    echo "ERROR: Registry should require authentication but didn't"
    exit 1
  fi

  # Run concierge to prepare MicroK8s with the registry mirror
  "$SPREAD_PATH"/concierge --trace prepare

  # Verify the hosts.toml was created with the correct content
  test -f /var/snap/microk8s/current/args/certs.d/docker.io/hosts.toml
  cat /var/snap/microk8s/current/args/certs.d/docker.io/hosts.toml
  grep -q 'server = "http://localhost:5000"' /var/snap/microk8s/current/args/certs.d/docker.io/hosts.toml
  grep -q 'capabilities = \["pull", "resolve"\]' /var/snap/microk8s/current/args/certs.d/docker.io/hosts.toml
  grep -q 'Authorization = \["Basic' /var/snap/microk8s/current/args/certs.d/docker.io/hosts.toml

  # Verify microk8s is running
  sudo microk8s status --wait-ready

  # Pull an image through the authenticated mirror using --hosts-dir so ctr
  # reads the hosts.toml we configured, and --user to authenticate against Zot.
  # Note: ctr's --user handles the Basic auth challenge from the registry,
  # while the hosts.toml header provides credentials for CRI-based pulls (e.g. pods).
  sudo microk8s ctr --namespace k8s.io images pull --hosts-dir /var/snap/microk8s/current/args/certs.d --user "${REGISTRY_USERNAME}:${REGISTRY_PASSWORD}" docker.io/library/busybox:latest

  # Verify the mirror was actually used by checking Zot's log for pull requests
  echo "--- Zot log ---"
  cat /var/log/zot.log
  echo "--- end Zot log ---"
  grep -q "busybox" /var/log/zot.log

  # Stop Zot
  kill $ZOT_PID 2>/dev/null || true
  wait $ZOT_PID 2>/dev/null || true

restore: |
  kill $(pgrep -f "zot serve") 2>/dev/null || true
  if [[ -z "${CI:-}" ]]; then
    "$SPREAD_PATH"/concierge --trace restore
  fi
